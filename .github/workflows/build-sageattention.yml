name: Build SageAttention Wheel

on:
  workflow_dispatch:
    inputs:
      sageattention_version:
        description: 'SageAttention version to build'
        required: true
        default: '2.2.0'
      pytorch_version:
        description: 'PyTorch version'
        required: true
        default: '2.10.0'
  schedule:
    # Run weekly on Monday at 04:00 UTC
    - cron: '0 4 * * 1'

env:
  PYTHON_VERSION: '3.13'
  CUDA_VERSION: '13.0'
  TORCH_CUDA_ARCH_LIST: '8.9'  # RTX 4090

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.16
        with:
          cuda: ${{ env.CUDA_VERSION }}
          method: 'network'
          sub-packages: '["nvcc", "cudart", "nvrtc", "cublas"]'

      - name: Verify CUDA installation
        run: |
          nvcc --version
          echo "CUDA_HOME=$CUDA_HOME"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools ninja
          pip install torch==${{ inputs.pytorch_version || '2.10.0' }} --index-url https://download.pytorch.org/whl/cu${{ 130 }}

      - name: Clone SageAttention repository
        run: |
          git clone https://github.com/thu-ml/SageAttention.git
          cd SageAttention
          git checkout v${{ inputs.sageattention_version || '2.2.0' }} || git checkout main
          echo "Building from commit: $(git rev-parse HEAD)"

      - name: Build SageAttention wheel
        run: |
          cd SageAttention
          export TORCH_CUDA_ARCH_LIST="${{ env.TORCH_CUDA_ARCH_LIST }}"
          export MAX_JOBS=4
          python setup.py bdist_wheel
        env:
          CUDA_HOME: ${{ env.CUDA_HOME }}

      - name: List built wheels
        run: |
          ls -lh SageAttention/dist/

      - name: Test wheel installation
        run: |
          pip install SageAttention/dist/*.whl
          python -c "import sageattention; print(f'SageAttention imported successfully')"

      - name: Get wheel name
        id: wheel_name
        run: |
          WHEEL_PATH=$(ls SageAttention/dist/*.whl)
          WHEEL_NAME=$(basename $WHEEL_PATH)
          echo "wheel_name=$WHEEL_NAME" >> $GITHUB_OUTPUT
          echo "wheel_path=$WHEEL_PATH" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: sageattention-v${{ inputs.sageattention_version || '2.2.0' }}-py${{ 313 }}-cu${{ 130 }}
          name: SageAttention v${{ inputs.sageattention_version || '2.2.0' }} (Python ${{ env.PYTHON_VERSION }}, CUDA ${{ env.CUDA_VERSION }})
          body: |
            # SageAttention Wheel for Python ${{ env.PYTHON_VERSION }} + CUDA ${{ env.CUDA_VERSION }}

            Built with:
            - Python: ${{ env.PYTHON_VERSION }}
            - CUDA: ${{ env.CUDA_VERSION }}
            - PyTorch: ${{ inputs.pytorch_version || '2.10.0' }}
            - CUDA Arch: ${{ env.TORCH_CUDA_ARCH_LIST }}

            ## Installation

            ```bash
            pip install ${{ steps.wheel_name.outputs.wheel_name }}
            ```

            Or directly from this release:

            ```bash
            pip install https://github.com/${{ github.repository }}/releases/download/sageattention-v${{ inputs.sageattention_version || '2.2.0' }}-py${{ 313 }}-cu${{ 130 }}/${{ steps.wheel_name.outputs.wheel_name }}
            ```

            ## Notes

            SageAttention provides optimized attention mechanisms with improved throughput and reduced memory usage.
            Compatible with PyTorch ${{ inputs.pytorch_version || '2.10.0' }} and CUDA ${{ env.CUDA_VERSION }}.
          files: ${{ steps.wheel_name.outputs.wheel_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sageattention-py${{ env.PYTHON_VERSION }}-cu${{ env.CUDA_VERSION }}
          path: ${{ steps.wheel_name.outputs.wheel_path }}
          retention-days: 30

name: Build All Wheels

on:
  workflow_dispatch:
    inputs:
      pytorch_version:
        description: 'PyTorch version for all builds'
        required: true
        default: '2.10.0'
      nunchaku_version:
        description: 'Nunchaku version'
        required: false
        default: '1.0.2'
      flash_attn_version:
        description: 'Flash Attention version'
        required: false
        default: '2.8.2'
      sageattention_version:
        description: 'SageAttention version'
        required: false
        default: '2.2.0'
  schedule:
    # Run monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'

jobs:
  trigger-builds:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Nunchaku build
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-nunchaku.yml',
              ref: 'main',
              inputs: {
                nunchaku_version: '${{ inputs.nunchaku_version || '1.0.2' }}',
                pytorch_version: '${{ inputs.pytorch_version || '2.10.0' }}'
              }
            });

      - name: Trigger Flash Attention build
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-flash-attention.yml',
              ref: 'main',
              inputs: {
                flash_attn_version: '${{ inputs.flash_attn_version || '2.8.2' }}',
                pytorch_version: '${{ inputs.pytorch_version || '2.10.0' }}'
              }
            });

      - name: Trigger SageAttention build
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-sageattention.yml',
              ref: 'main',
              inputs: {
                sageattention_version: '${{ inputs.sageattention_version || '2.2.0' }}',
                pytorch_version: '${{ inputs.pytorch_version || '2.10.0' }}'
              }
            });

      - name: Summary
        run: |
          echo "## Build Jobs Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All wheel build workflows have been triggered:" >> $GITHUB_STEP_SUMMARY
          echo "- Nunchaku v${{ inputs.nunchaku_version || '1.0.2' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Flash Attention v${{ inputs.flash_attn_version || '2.8.2' }}" >> $GITHUB_STEP_SUMMARY
          echo "- SageAttention v${{ inputs.sageattention_version || '2.2.0' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PyTorch version: ${{ inputs.pytorch_version || '2.10.0' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the Actions tab for build progress." >> $GITHUB_STEP_SUMMARY

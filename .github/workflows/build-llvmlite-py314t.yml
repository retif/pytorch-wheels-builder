name: Build llvmlite Wheel (Python 3.14t Free-threaded)

on:
  workflow_dispatch:
    inputs:
      llvmlite_version:
        description: 'llvmlite version to build'
        required: true
        default: '0.44.0'
  schedule:
    # Run weekly on Monday at 10:00 UTC
    - cron: '0 10 * * 1'

env:
  PYTHON_VERSION: '3.14t'  # Free-threaded Python (cp314t)
  LLVM_VERSION: '14'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - name: Set up Python ${{ env.PYTHON_VERSION }} (free-threaded)
        uses: actions/setup-python@v5
        with:
          python-version: '3.14t'  # Free-threaded Python (no GIL) - cp314t
          architecture: 'x64'
          allow-prereleases: true

      - name: Verify Python configuration (free-threaded)
        run: |
          python --version
          python -c "import sys; print(f'Python: {sys.version}')"
          python -c "import sys; print(f'ABI tag: {sys.abiflags}')"
          python -c "import sysconfig; print(f'Platform tag: {sysconfig.get_platform()}')"
          # Verify we have free-threaded Python (no GIL) - should show 't' in abiflags
          python -c "import sys; print(f'ABI flags: {sys.abiflags}')"
          python -c "import sys; gil_disabled = not getattr(sys, '_is_gil_enabled', lambda: True)(); print(f'Free-threaded (GIL disabled): {gil_disabled}'); exit(0 if gil_disabled else 1)"
          echo "âœ“ Confirmed: Building for free-threaded Python (cp314t)"

      - name: Install LLVM
        run: |
          # Install LLVM 14 (compatible with llvmlite)
          sudo apt-get update
          sudo apt-get install -y llvm-${{ env.LLVM_VERSION }} llvm-${{ env.LLVM_VERSION }}-dev

          # Set environment variables
          echo "LLVM_CONFIG=/usr/bin/llvm-config-${{ env.LLVM_VERSION }}" >> $GITHUB_ENV

          # Verify LLVM installation
          llvm-config-${{ env.LLVM_VERSION }} --version
          llvm-config-${{ env.LLVM_VERSION }} --prefix

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          # llvmlite build dependencies
          pip install cmake

      - name: Clone llvmlite repository
        run: |
          git clone https://github.com/numba/llvmlite.git
          cd llvmlite
          git checkout v${{ inputs.llvmlite_version || '0.44.0' }} || git checkout main
          echo "Building from commit: $(git rev-parse HEAD)"

      - name: Patch setup.py for version metadata
        run: |
          cd llvmlite
          # Inject LLVM version into package version string
          LLVM_VERSION="${{ env.LLVM_VERSION }}"
          VERSION_SUFFIX="+llvm${LLVM_VERSION}"

          # Check if version already has the correct metadata
          if grep -q "${VERSION_SUFFIX}" setup.py; then
            echo "Version already has correct metadata: ${VERSION_SUFFIX}"
          else
            # Remove any existing version metadata to avoid duplicates
            sed -i 's/version=\(['\''"][^+]*\)+[^'\''"]*/version=\1/' setup.py

            # Now add our version metadata
            sed -i "s/version=\(['\"][^'\"]*['\"\]\)/version=\1.replace('\"', '').replace(\"'\", '') + '${VERSION_SUFFIX}'/" setup.py
            echo "Patched version to include: ${VERSION_SUFFIX}"
          fi

      - name: Build llvmlite wheel
        run: |
          cd llvmlite
          export LLVM_CONFIG=/usr/bin/llvm-config-${{ env.LLVM_VERSION }}
          python setup.py bdist_wheel

      - name: List built wheels
        run: |
          ls -lh llvmlite/dist/

      - name: Test wheel installation
        run: |
          pip install llvmlite/dist/*.whl
          python -c "import llvmlite; print(f'llvmlite version: {llvmlite.__version__}')"
          python -c "import llvmlite.binding as llvm; llvm.initialize(); llvm.initialize_native_target(); llvm.initialize_native_asmprinter(); print('llvmlite binding initialized successfully')"

      - name: Get wheel name
        id: wheel_name
        run: |
          WHEEL_PATH=$(ls llvmlite/dist/*.whl)
          WHEEL_NAME=$(basename $WHEEL_PATH)
          echo "wheel_name=$WHEEL_NAME" >> $GITHUB_OUTPUT
          echo "wheel_path=$WHEEL_PATH" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: llvmlite-v${{ inputs.llvmlite_version || '0.44.0' }}-py314t-llvm${{ env.LLVM_VERSION }}
          name: llvmlite v${{ inputs.llvmlite_version || '0.44.0' }} Wheel for Python ${{ env.PYTHON_VERSION }} (Free-threaded) + LLVM ${{ env.LLVM_VERSION }}
          body: |
            Built with:
            - Python: ${{ env.PYTHON_VERSION }} (Free-threaded, no GIL - cp314t)
            - LLVM: ${{ env.LLVM_VERSION }}

            ## Installation

            **Note:** This wheel is built for free-threaded Python 3.14 (cp314t). You need Python 3.14t installed.

            ```bash
            pip install ${{ steps.wheel_name.outputs.wheel_name }}
            ```

            Or directly from this release:

            ```bash
            pip install https://github.com/${{ github.repository }}/releases/download/llvmlite-v${{ inputs.llvmlite_version || '0.44.0' }}-py314t-llvm${{ env.LLVM_VERSION }}/${{ steps.wheel_name.outputs.wheel_name }}
            ```

            ## Notes

            llvmlite is a lightweight LLVM Python binding for writing JIT compilers.
            This wheel is built for **free-threaded Python 3.14t** (experimental, no GIL) with LLVM ${{ env.LLVM_VERSION }}.

            llvmlite is required by Numba and other JIT compilation frameworks.
          files: ${{ steps.wheel_name.outputs.wheel_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload wheel as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: llvmlite-py314t-llvm${{ env.LLVM_VERSION }}
          path: ${{ steps.wheel_name.outputs.wheel_path }}
          retention-days: 30
